# åŸå¸‚é€‰æ‹©æ§ä»¶

æƒ³åˆ°åšè¿™ä¸ªï¼Œæ˜¯å› ä¸ºæ— æ„ä¸­åœ¨githubä¸Šçœ‹åˆ°äº†è¿™ä¸€ä¸ªä»“åº“[https://github.com/lunlunshiwo/ChooseCity](https://github.com/lunlunshiwo/ChooseCity)ï¼Œåšçš„å°±æ˜¯ä¸€ä¸ªåŸå¸‚é€‰æ‹©æ§ä»¶ï¼Œæ˜¯ç”¨vueå†™çš„ï¼Œè¯´çš„æ˜¯é˜¿é‡Œçš„ä¸€é“é¢˜ç›®ï¼Œç„¶åæƒ³æƒ³è‡ªå·±é—²ç€ä¹Ÿæ˜¯é—²ç€ï¼Œå°±åŠ¨æ‰‹ç”¨reactåˆé‡æ–°åšäº†ä¸€éã€‚

## æ¼”ç¤º

åœ°å€ï¼š[åŸå¸‚é€‰æ‹©æ§ä»¶](http://city-selector.rynxiao.cn/)

github: [https://github.com/Rynxiao/city-selector](https://github.com/Rynxiao/city-selector)

æ•´ä½“æ•ˆæœå¦‚ä¸‹ï¼š

![demo](./screen/demo.gif)

## è¿è¡Œ

è¿è¡Œéœ€çŸ¥ï¼šé¦–å…ˆå»ç™¾åº¦å¼€æ”¾äº‘å¹³å°ç”³è¯·è‡ªå·±çš„AKï¼Œç”³è¯·æ–¹æ³•è§ä¸‹é¢çš„**å®šä½**

```cmd
# dev
npm install
npm start

# deploy
npm run build
npm install http-server -g
http-server ./build -p 38083 -s -P http://www.msece.com
localhost:38083

# test
npm run test
```

## è¦æ±‚

- å¯å®šä½åˆ°å½“å‰æ‰€åœ¨åŸå¸‚ï¼Œå¯æ”¯æŒä¼ åŸå¸‚
- ä¸‹æ¬¡æ‰“å¼€ä¼˜å…ˆé€‰å–ä¸Šæ¬¡å®šä½åŸå¸‚ï¼Œå¦‚æœ¬æ¬¡å®šä½å’Œä¸Šæ¬¡ä¸ä¸€æ ·ï¼Œåˆ™å–æœ¬åœ°åŸå¸‚ï¼ŒåŒæ—¶å±•ç¤ºæœ€è¿‘é€‰æ‹©çš„åŸå¸‚ï¼Œæœ€è¿‘é€‰æ‹©çš„åŸå¸‚å¯é…
- åŸå¸‚åˆ—è¡¨æŒ‰å­—æ¯åˆ†ç»„ï¼Œå¦‚Bç»„ï¼šåŒ—äº¬ã€åŒ…å¤´ï¼ŒåŒæ—¶å·¦ä¾§å¸¦A-Zå¯¼èˆªç¬¦æ¡ï¼Œç‚¹å‡»å¯¹åº”å­—æ¯å®šä½è‡³å¯¹åº”çš„ç»„ä½ç½®ï¼Œå¦‚ç‚¹å‡»Cåˆ™å®šä½è‡³Cç»„ï¼ŒåŒæ—¶å¼¹å‡ºæç¤ºä¸ºC
- æ”¯æŒåŸå¸‚æœç´¢ï¼Œé¡µå¤´å¸¦æœç´¢æ¡†ï¼Œå¯æ”¯æŒè”æƒ³åŠŸèƒ½ï¼Œæ³¨æ„æ€§èƒ½
- é€‰æ‹©å¯¹åº”åŸå¸‚ï¼Œä¼šå°†å¯¹åº”åŸå¸‚æ•°æ®å¸¦å›ç»™ä½¿ç”¨é¡µé¢
- æ”¯æŒå•ä¸ªé¡µé¢ä¸ŠåŒæ—¶å­˜åœ¨å¤šä¸ªåŸå¸‚ç»„ä»¶
- é¡µé¢ç”¨flexå¸ƒå±€ï¼ˆcssï¼‰

## è¯´æ˜

ä¸ªäººé‡‡ç”¨çš„è·¯ç”±å½¢å¼ï¼Œå› æ­¤æ²¡æœ‰åšæˆä¸€ä¸ªå…·ä½“çš„ç»„ä»¶(è¦ç»„ä»¶åŒ–ä¹Ÿå°±æ˜¯æŠŠstateæ¢æˆpropsä¼ å€¼å³å¯)ï¼Œä½†æ˜¯åœ¨æ•´ä¸ªé¡µé¢ä¸­åšäº†å¾ˆå°å•å…ƒçš„æ‹†åˆ†ã€‚å¦å¤–â€œä¸Šæ¬¡å®šä½â€çš„åŠŸèƒ½æš‚æ—¶æœªå®Œå–„ï¼Œå®¹ä¹‹åè¡¥ä¸Šã€‚

## æŠ€æœ¯æ ˆ

é‡‡ç”¨çš„æ˜¯reactå®˜ç½‘æä¾›çš„è„šæ‰‹æ¶[create-react-app](https://github.com/facebook/create-react-app)ï¼Œå› æ­¤æ•´ä½“æŠ€æœ¯æ˜¯`react`ï¼Œé‡‡ç”¨`webpack`è¿›è¡Œæ‰“åŒ…æ„å»ºï¼Œ`jest`æµ‹è¯•ã€‚åŒæ—¶åœ¨æ­¤åŸºç¡€ä¸Šæ–°å¢äº†ä¸€äº›ä¸œè¥¿ã€‚

### sass

è„šæ‰‹æ¶æœ€å¼€å§‹ä¸æ”¯æŒsassï¼Œå¼€å¯sasséœ€è¦å¦‚ä¸‹é…ç½®ï¼š

```cmd
# å®‰è£…ä¾èµ–åŒ…
npm install --save node-sass-chokidar
npm install --save npm-run-all

# è„šæœ¬ä¸­å¢åŠ build-cssä¸watch-css
# ä¿®æ”¹startå’Œbuildå‘½ä»¤ï¼Œè®©å…¶å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå‘½ä»¤
"scripts": {
+    "build-css": "node-sass-chokidar --include-path ./src --include-path ./node_modules src/ -o src/",
+    "watch-css": "npm run build-css && node-sass-chokidar --include-path ./src --include-path ./node_modules src/ -o src/ --watch --recursive",
     "test": "react-scripts test --env=jsdom",
-    "start": "react-scripts start",
-    "build": "react-scripts build",
+    "start-js": "react-scripts start",
+    "start": "npm-run-all -p watch-css start-js",
+    "build-js": "react-scripts build",
+    "build": "npm-run-all build-css build-js"
}

# .gitignoreä¸­å»é™¤ç”Ÿæˆçš„cssæ–‡ä»¶
src/**/*.css
```

### react-router

```cmd
npm install --save react-router-dom
```

å®‰è£…ä¾èµ–ä¹‹åï¼Œå¢åŠ äº†ä¸€ä¸ªå…¨å±€å…¥å£ï¼Œåœ¨`src/container/index.js`ä¸­ï¼Œå¦‚ä¸‹ï¼š

```javascript
<Switch>
    <Route exact path="/" component={ App } />
    <Route path="/city" component={ City } />
</Switch>
```

å¢åŠ ä¸¤ä¸ªé¡µé¢ï¼Œè·¯ç”±åˆ†åˆ«å¦‚ä¸Šé…ç½®ã€‚

### å®šä½

éœ€è¦å®šä½åˆ°å½“å‰åŸå¸‚ï¼Œé‡‡ç”¨çš„æ˜¯ç™¾åº¦åœ°å›¾çš„å®šä½ï¼Œéœ€è¦é¦–å…ˆå»ç™¾åº¦åœ°å›¾å¼€æ”¾å¹³å°ä¸Šç”³è¯·ä¸€ä¸ªç§˜é’¥ï¼Œåœ°å€åœ¨è¿™é‡Œ[http://lbsyun.baidu.com/apiconsole/key](http://lbsyun.baidu.com/apiconsole/key)ï¼Œè¿›å»ä¹‹åæŸ¥çœ‹jsæ–‡æ¡£ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œå¯ä»¥è‡ªå·±å»äº†è§£ã€‚

- åœ¨`src/public/index.html`ä¸­åŠ å…¥ç™¾åº¦å¼€æ”¾å¹³å°æä¾›çš„è„šæœ¬é“¾æ¥ï¼Œå¡«ä¸Šè‡ªå·±çš„ç§˜é’¥ã€‚

```html
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=your_ak"></script>
```

- `src/services/locationServices.js`ä¸­åŠ å…¥å®šä½ä»£ç 

```javascript
async function getLocalCity() {
    return new Promise(resolve => {
        var myCity = new window.BMap.LocalCity();
        myCity.get(result => {
            resolve(result.name);
        });
    }); 
}
```

### è·å–åŸå¸‚æ•°æ®

è·å–åŸå¸‚çš„æ¥å£APIï¼Œå†ç»åƒè¾›ä¸‡è‹¦ç»ˆäºåœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªèƒ½ç”¨çš„ã€è¿™ä¸ªæ¥å£æœ‰å¯èƒ½éšæ—¶ä¼šæŒ‚å“ŸğŸ˜ğŸ˜ğŸ˜ã€‘ï¼Œä½†æ˜¯æ•°æ®æ ¼å¼å¯èƒ½ä¸å¤ªæ»¡æ„ï¼Œåªèƒ½è‡ªå·±è½¬åŒ–ã€‚å¦‚æœä¸æƒ³ç”¨è¿™ä¸ªæ ¼å¼ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±èµ·ä¸€ä¸ªåå°æœåŠ¡å™¨ï¼Œç„¶åè¾“å‡ºä½ è‡ªå·±å–œæ¬¢çš„æ ¼å¼ï¼Œè¿™é‡Œæˆ‘ç®—æ˜¯å·æ‡’äº†ã€‚

ä¹‹å‰çš„æ ¼å¼æ˜¯æŒ‰ç…§çœä»½åŒºåˆ†çš„ï¼š

![before-format-json](./screen/before-format-json.png)

æ ¼å¼åŒ–ä¹‹åçš„æ ¼å¼æ˜¯æŒ‰ç…§æ‹¼éŸ³å­—æ¯æ¥åŒºåˆ†çš„:

![after-format-json](./screen/after-format-json.png)

**è®¾ç½®ä»£ç†**

å› ä¸ºè¯·æ±‚çš„åœ°å€åŸŸåä¸ä¸€è‡´ï¼Œè‚¯å®šä¼šæœ‰è·¨åŸŸé—®é¢˜ï¼Œè¿™é‡Œåœ¨package.jsonä¸­è®¾ç½®äº†ä»£ç†ï¼Œå¦‚ä¸‹ï¼š

```javascript
"proxy": "http://www.msece.com"
```

**è·å–åŸå¸‚**

```javascript
// src/services/cityServices.js
async function getAllCities() {
    const json = await axios.get(CITY_API);
    return formatCites(json);
}
```

### UI

UIæ–¹é¢è‡ªå·±æ²¡æœ‰ä»€ä¹ˆåˆ›æ„ï¼Œæ‰€ä»¥ä½¿ç”¨äº†é˜¿é‡Œçš„`antd-mobile`ï¼Œå¯ä»¥å»è¿™é‡Œçœ‹ï¼š[antd-mobile](https://mobile.ant.design/docs/react/introduce-cn)

```javascript
// å®‰è£…ä¾èµ–
npm install antd-mobile --save

// æŒ‰éœ€åŠ è½½
// 1. å®‰è£…ä¾èµ–
npm install react-app-rewired --save-dev
npm install babel-plugin-import --save-dev

// 2. åœ¨package.jsonä¸­ï¼Œå°†scriptä¸­çš„ react-scripts æ¢æˆ react-app-rewired

// 3. åœ¨æ ¹ç›®å½•ä¸‹å»ºç«‹config-overrides.jsï¼Œå†…å®¹å¦‚ä¸‹ï¼š
const { injectBabelPlugin } = require('react-app-rewired');

module.exports = function override(config, env) {
    config = injectBabelPlugin(['import', { libraryName: 'antd-mobile', style: 'css' }], config);
    return config;
};

// 4. æ›´æ”¹å¼•å…¥æ–¹å¼
// before
import Button from 'antd-mobile/lib/button';
// after
import { Button } from 'antd-mobile';
```

## coding

è¿›è¡Œäº†ç»„ä»¶çš„æ‹†åˆ†ï¼Œä¸»è¦ä¸ºï¼š

- å¤´éƒ¨
- æœç´¢åŒºåŸŸ
- éœ€è¦å®šä½çš„åŸå¸‚åŒºåŸŸï¼ˆåˆ†ä¸ºæœ€è¿‘åŸå¸‚å’Œçƒ­é—¨åŸå¸‚ï¼‰
- åˆ—è¡¨åŒºåŸŸ
- å³ä¾§å¯¼èˆªåŒºåŸŸ
- æœç´¢å¼¹å±‚åŒºåŸŸ

å…·ä½“å¯ä»¥å‚çœ‹`src/components/city`ä¸‹çš„ç»„ä»¶

### æœ€è¿‘é€‰æ‹©åŸå¸‚

é‡‡ç”¨çš„æ˜¯æœ¬åœ°localstorageè¿›è¡Œå­˜å‚¨ï¼Œé»˜è®¤æœ€å¤šå­˜å‚¨ä¸¤ä¸ªï¼Œåé€‰æ‹©çš„åŸå¸‚ä¼šæ›¿æ¢æ‰ç¬¬ä¸€ä¸ªï¼Œå¦‚æœé€‰æ‹©çš„åŸå¸‚ä¸­æœ‰ç›¸åŒçš„ï¼Œåˆ™ä¸è¿›è¡Œæ›¿æ¢ã€‚é¡µé¢å…¬ç”¨æœ¬åœ°å­˜å‚¨ï¼Œè‹¥ä¸æƒ³å…¬ç”¨ï¼Œå¯ä»¥åœ¨ä¹‹ååŒºåˆ†idå³å¯ã€‚

### çƒ­é—¨åŸå¸‚

çƒ­é—¨åŸå¸‚æ˜¯è‡ªå·±é¢„å…ˆå®šä¹‰çš„ï¼Œå¦‚æœä¸å¸Œæœ›é¢„å…ˆå®šä¹‰ï¼Œä¹Ÿå¯ä»¥å‚ç…§æŸäº›APIï¼Œè¿™é‡Œç®—æ˜¯å·æ‡’ã€‚

### å¯¼èˆªæ¡æ»‘åŠ¨

ä¹‹å‰çš„å†™è¿‡ä¸€ç¯‡æ–‡ç« [ç§»åŠ¨ç«¯æ•ˆæœä¹‹IndexList](https://www.cnblogs.com/rynxiao/p/7694601.html)ï¼Œå…·ä½“å®ç°å¯ä»¥å‚çœ‹ã€‚

### æœç´¢è”åŠ¨

æ”¯æŒä¸­/è‹±æ–‡æœç´¢ï¼Œä¸­æ–‡æœç´¢æ˜¯è¿›è¡Œäº†å…¨æ•°æ®éå†ï¼Œè‹±æ–‡æœç´¢æ˜¯è¿›è¡Œäº†é¦–å­—ç¬¦åˆ¤æ–­ï¼Œç„¶åå†è¿›è¡Œå­é›†éå†ã€‚åœ¨æœç´¢æ–¹é¢ï¼Œä½¿ç”¨äº†å‡½æ•°èŠ‚æµï¼Œå¦‚æœåœ¨1ç§’ä¸­ä¹‹å†…è¿˜æ²¡æœ‰è¾“å…¥å®Œæˆï¼Œåˆ™å¿…é¡»è¿›è¡Œä¸€æ¬¡æœç´¢ã€‚

```javascript
// src/utils/index.js
function throttle(fn, wait = 500, period = 1000) {
    let startTime = new Date().getTime();
    let timeout;
    return (...args) => {
        return new Promise(resolve => {
            const now = new Date().getTime();
            if (now - startTime >= period) {
                startTime = now;
                resolve(fn.apply(null, args));
            } else {
                timeout && clearTimeout(timeout);
                timeout = setTimeout(() => {
                    resolve(fn.apply(null, args));
                }, wait);
            }
        }); 
    }
}

// src/pages/city/City.js
const searchCity = throttle(searchCityByName);

onSearchInput = async value => {
    if (!value) {
        this.hideMenuDialog();
        return;
    }

    const { labels, city } = this.state;
    const cities = await searchCity(value, labels, city);
    this.setState({  
        searchArea: true, 
        searchCities: transformCityMenuData(cities) 
    });
}
```

### éƒ¨ç½²æ–¹é¢

æœ¬æ¥æ˜¯æƒ³ä½¿ç”¨`heroku`æ¥éƒ¨ç½²åº”ç”¨çš„ï¼Œä½†æ˜¯ç»è¿‡ä¸€ç•ªæŠ˜è…¾ä¹‹åï¼Œåœ¨herokuçš„æ—¥å¿—ä¸­çœ‹åˆ°æœåŠ¡æ˜¯å·²ç»å¯åŠ¨äº†çš„ï¼Œä½†æ˜¯å¤–ç½‘è®¿é—®ä¸äº†ï¼Œè¿˜éœ€è¦æŠ€æœ¯æ”¯æŒ^_^

![heroku-logs](./screen/heroku-logs.png)

åæ¥åªèƒ½å°±éƒ¨ç½²åˆ°è‡ªå·±çš„è…¾è®¯äº‘ä¸Šé¢å»äº†ï¼Œæ¡ˆä¾‹åœ°å€ä¸ºï¼š[åŸå¸‚é€‰æ‹©æ§ä»¶](http://city-selector.rynxiao.cn/)

## æ€»ç»“

è‡ªå·±çœ‹åˆ°åå°±æƒ³å†™æ¥ç©ç©è€Œå·²ï¼Œåœ¨å…¶ä¸­ä¹Ÿè¿›ä¸€æ­¥äº†è§£äº†æµ‹è¯•ã€react-router 4çš„ç”¨æ³•ï¼Œä»¥åŠèš‚èšé‡‘æœçš„UIåº“ï¼Œä¹Ÿä¸æ˜¯è¯´æ²¡æœ‰æ”¶è·ã€‚åœ¨é¡¹ç›®ä¸­ï¼Œä¹Ÿç»è¿‡äº†ä¸€ç³»åˆ—çš„ä»£ç é‡æ„ï¼Œæ¯”å¦‚ç»„ä»¶æ‹†åˆ†ã€å…¬å…±ç±»åº“æå–ç­‰ç­‰ï¼Œå†™æ¡ˆä¾‹çš„åŒæ—¶ä¹Ÿæ˜¯åœ¨è®­ç»ƒè‡ªå·±çš„æ„è¯†ï¼Œç‰¹æ„åˆ†äº«å‡ºæ¥ï¼Œå¤§å®¶å…±å‹‰ã€‚

æœ€åï¼Œä»£ç ä»“åº“ä¸ºï¼š[https://github.com/Rynxiao/city-selector](https://github.com/Rynxiao/city-selector)ï¼Œå¦‚æœè§‰å¾—æœ‰ç‚¹æ„æ€ï¼Œå¤šè°¢starã€‚







